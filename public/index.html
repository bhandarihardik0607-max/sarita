<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarita Groceries</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary-green: #22c55e;
            --light-green: #f0fdf4;
            --dark-text: #1f2937;
            --light-text: #6b7280;
            --bg-color: #f7fef9;
            --border-color: #f3f4f6;
        }
        body {
            font-family: 'Manrope', sans-serif;
            background-image: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
        }
        .page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            overflow-y: auto;
            background-color: transparent;
        }
        .page-main { transform: translateX(0); z-index: 10; }
        .page-detail { transform: translateX(100%); z-index: 20; background-color: white; }
        .page.active { transform: translateX(0); }
        .loader { border: 4px solid #e5e7eb; border-top: 4px solid var(--primary-green); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-out;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .checkout-step { display: none; }
        .checkout-step.active { display: block; animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide { display: none; animation: fade 1.5s ease-in-out; }
        @keyframes fade { from {opacity: .4} to {opacity: 1} }
        
        .category-icon { transition: transform 0.2s ease-in-out; }
        .category-icon:hover { transform: scale(1.1); }
        .add-to-cart-btn { transition: transform 0.2s, background-color 0.2s; }
        .add-to-cart-btn:active { transform: scale(0.9); }
    </style>
</head>
<body>
    <div id="global-loader" class="fixed inset-0 z-[200] flex items-center justify-center bg-white/80 backdrop-blur-sm">
        <div class="loader"></div>
    </div>
    <div id="toast-notification" class="toast fixed bottom-20 right-5 z-[200]"></div>
    
    <div class="relative max-w-sm mx-auto border-x h-screen overflow-hidden bg-white shadow-2xl">
        <!-- Main Page -->
        <div id="page-main" class="page page-main active">
            <!-- Header -->
            <header class="p-4 flex justify-between items-center bg-white">
                <button id="my-orders-btn"><i data-lucide="user-circle-2"></i></button>
                <div class="text-center">
                    <h1 class="font-bold" id="header-store-name">Sarita Groceries</h1>
                    <span class="text-sm text-gray-500 flex items-center gap-1"><i data-lucide="map-pin" class="w-4 h-4"></i> Sanchore, Rajasthan</span>
                </div>
                <button id="cart-button" class="relative">
                    <i data-lucide="shopping-bag"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 h-5 w-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">0</span>
                </button>
            </header>

            <div class="overflow-y-auto pb-24">
                <!-- Search Bar -->
                <div class="p-4">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search products..." class="w-full bg-gray-100 rounded-full py-3 px-5 pl-12 border-2 border-transparent focus:outline-none focus:border-green-400 transition">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Slideshow -->
                <div id="slideshow-container" class="px-4 mb-6 relative"></div>

                <!-- Categories -->
                <section class="px-4 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="font-bold text-lg">Top Categories</h2>
                    </div>
                    <div id="categories-grid" class="flex gap-4 overflow-x-auto pb-2"></div>
                </section>

                <!-- Products -->
                <section class="px-4 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 id="product-section-title" class="font-bold text-lg">Exclusive Offer</h2>
                    </div>
                    <div id="product-grid" class="grid grid-cols-2 gap-4"></div>
                    <div id="no-products-message" class="hidden text-center py-12 text-gray-500">
                        <i data-lucide="search-x" class="mx-auto h-12 w-12"></i>
                        <h3 class="mt-2 text-lg font-medium">No Products Found</h3>
                    </div>
                </section>
            </div>
        </div>

        <!-- Product Detail Page -->
        <div id="page-detail" class="page page-detail">
            <!-- Content will be injected by JS -->
        </div>
        
        <!-- Floating Contact Button -->
        <button id="contact-fab" class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white rounded-full p-4 shadow-lg z-50 flex items-center gap-2 transform hover:scale-110 transition-transform">
            <i data-lucide="phone"></i>
        </button>
    </div>
    
    <!-- Modals -->
    <div id="modals-container">
        <div id="checkout-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100]"></div>
        <div id="order-history-lookup-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4"></div>
        <div id="order-history-display-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4"></div>
        <div id="contact-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://dpyzcwzvyuuvtefyqnqu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRweXpjd3p2eXV1dnRlZnlxbnF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MDc1NjksImV4cCI6MjA3NDM4MzU2OX0.WMtixHcEcmzVERmZVe71geAts3PVrIKKG3r7MEZhzRE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const LOCATIONIQ_API_KEY = 'pk.8405f9d2a07fcdd7537b13a3e342c199'; 

        const app = {
            state: { cart: [], checkout: {}, currentCategory: 'all', searchQuery: '', currentSlide: 0, slideTimeout: null },
            db: {},
            methods: {
                async init() {
                    this.loadCart();
                    this.setupEventListeners();
                    await this.loadInitialData();
                    this.renderAll();
                    document.getElementById('global-loader').classList.add('hidden');
                },
                async loadInitialData() {
                    const [settingsRes, slideshowRes, productsRes, categoriesRes] = await Promise.all([
                        supabaseClient.from('settings').select('*').limit(1).single(),
                        supabaseClient.from('slideshow').select('*').eq('status', 'Active'),
                        supabaseClient.from('products').select('*, variants(*)').eq('status', 'Active'),
                        supabaseClient.from('categories').select('*'),
                    ]);
                    app.db = {
                        settings: settingsRes.data || { store_name: 'Grocery Store' },
                        slideshow: slideshowRes.data || [],
                        products: productsRes.data || [],
                        categories: categoriesRes.data || []
                    };
                    document.getElementById('header-store-name').textContent = app.db.settings.store_name;
                },
                renderAll() {
                    this.renderSlideshow();
                    this.renderCategories();
                    this.renderProducts('Exclusive Offer');
                    this.updateCartCount();
                },
                renderSlideshow() {
                    const container = document.getElementById('slideshow-container');
                    if (!container || app.db.slideshow.length === 0) return;
                    
                    const slidesHTML = app.db.slideshow.map(slide => `<div class="slide aspect-[2/1] rounded-2xl overflow-hidden"><img src="${slide.img_url}" class="w-full h-full object-cover"></div>`).join('');
                    const arrowsHTML = `
                        <button onclick="app.methods.plusSlides(-1)" class="absolute top-1/2 left-2 -translate-y-1/2 bg-white/70 p-2 rounded-full shadow-md hover:bg-white transition"><i data-lucide="chevron-left"></i></button>
                        <button onclick="app.methods.plusSlides(1)" class="absolute top-1/2 right-2 -translate-y-1/2 bg-white/70 p-2 rounded-full shadow-md hover:bg-white transition"><i data-lucide="chevron-right"></i></button>
                    `;
                    container.innerHTML = slidesHTML + arrowsHTML;
                    this.showSlide(0);
                    lucide.createIcons();
                },
                plusSlides(n) { this.showSlide(app.state.currentSlide + n); },
                showSlide(index) {
                    clearTimeout(app.state.slideTimeout);
                    const slides = document.querySelectorAll('#slideshow-container .slide');
                    if (!slides.length) return;
                    app.state.currentSlide = (index + slides.length) % slides.length;
                    slides.forEach((slide, i) => slide.style.display = i === app.state.currentSlide ? 'block' : 'none');
                    app.state.slideTimeout = setTimeout(() => this.showSlide(app.state.currentSlide + 1), 4000);
                },
                renderCategories() {
                    const grid = document.getElementById('categories-grid');
                    if (!grid) return;
                    let categoriesHtml = `<div onclick="app.methods.filterByCategory('all', 'All Products')" class="text-center space-y-2 flex-shrink-0"><div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center category-icon"><i data-lucide="list" class="text-green-600"></i></div><p class="text-sm font-semibold">All</p></div>`;
                    categoriesHtml += app.db.categories.map(cat => `
                        <div onclick="app.methods.filterByCategory(${cat.id}, '${cat.name}')" class="text-center space-y-2 flex-shrink-0">
                            <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center p-2 category-icon"><img src="${cat.img_url}" alt="${cat.name}" class="max-w-full max-h-full object-contain"></div>
                            <p class="text-sm font-semibold">${cat.name}</p>
                        </div>
                    `).join('');
                    grid.innerHTML = categoriesHtml;
                    lucide.createIcons();
                },
                filterByCategory(categoryId, categoryName = 'Products') {
                    app.state.currentCategory = categoryId;
                    this.renderProducts(categoryName);
                },
                renderProducts(title) {
                    document.getElementById('product-section-title').textContent = title;
                    const grid = document.getElementById('product-grid');
                    const noProductsMsg = document.getElementById('no-products-message');
                    grid.innerHTML = '';
                    let productsToRender = app.db.products;

                    if (app.state.currentCategory !== 'all') {
                        productsToRender = app.db.products.filter(p => p.category_id === app.state.currentCategory);
                    }

                    if (app.state.searchQuery) {
                        productsToRender = productsToRender.filter(p => p.name.toLowerCase().includes(app.state.searchQuery.toLowerCase()));
                    }
                    
                    noProductsMsg.classList.toggle('hidden', productsToRender.length > 0);
                    grid.classList.toggle('hidden', productsToRender.length === 0);

                    productsToRender.forEach((p, index) => {
                        const firstActiveVariant = p.variants?.find(v => v.status === 'Active');
                        if (firstActiveVariant) grid.innerHTML += this.createProductCard(p, firstActiveVariant, index);
                    });
                    lucide.createIcons();
                },
                createProductCard(product, variant, index) {
                    const salePrice = parseFloat(variant.sale_price).toFixed(2);
                    const hasMultipleVariants = product.variants.filter(v => v.status === 'Active').length > 1;
                    
                    return `
                        <div class="product-card bg-white p-4 rounded-2xl border border-gray-100 space-y-2" onclick="app.methods.showProductDetail(${product.id})">
                            <img src="${product.img}" class="w-full h-24 object-contain mb-2">
                            <h3 class="font-bold text-md truncate">${product.name}</h3>
                            <p class="text-sm text-gray-500">${variant.unit}</p>
                            <div class="flex justify-between items-center">
                                <span class="font-extrabold text-lg">${app.db.settings.currency_symbol || '$'}${salePrice}</span>
                                <div id="action-container-${variant.id}" onclick="event.stopPropagation();">${this.getActionButtonHTML(variant.id, hasMultipleVariants, product.id)}</div>
                            </div>
                        </div>`;
                },
                getActionButtonHTML(variantId, hasMultipleVariants, productId) {
                    const itemInCart = app.state.cart.find(item => item.variantId === variantId);
                    if (itemInCart && !hasMultipleVariants) {
                        return `<div class="flex items-center justify-center bg-gray-100 font-bold rounded-full">
                            <button onclick="app.methods.updateCartQuantity(${variantId}, -1)" class="p-2 add-to-cart-btn"><i data-lucide="minus" class="w-4 h-4"></i></button>
                            <span class="text-md px-2">${itemInCart.quantity}</span>
                            <button onclick="app.methods.updateCartQuantity(${variantId}, 1)" class="p-2 add-to-cart-btn"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>`;
                    }
                    const action = hasMultipleVariants ? `app.methods.showProductDetail(${productId})` : `app.methods.addToCart(${variantId})`;
                    return `<button onclick="${action}" class="bg-green-500 text-white rounded-full p-2 hover:bg-green-600 add-to-cart-btn"><i data-lucide="plus"></i></button>`;
                },
                updateAllActionButtons(variantId) {
                    document.querySelectorAll(`[id^="action-container-${variantId}"]`).forEach(container => {
                        const product = this.getProductByVariantId(variantId);
                        if(product) {
                            const hasMultipleVariants = product.variants.filter(v => v.status === 'Active').length > 1;
                            container.innerHTML = this.getActionButtonHTML(variantId, hasMultipleVariants, product.id);
                            lucide.createIcons();
                        }
                    });
                },
                setupEventListeners() {
                    document.getElementById('cart-button').addEventListener('click', () => {
                        if (document.getElementById('page-detail').classList.contains('active')) {
                            this.hideProductDetail();
                        } else {
                            this.toggleCartModal(true);
                        }
                    });
                    document.getElementById('my-orders-btn').addEventListener('click', () => this.openOrderHistoryLookup());
                    document.getElementById('search-input').addEventListener('input', (e) => {
                        app.state.searchQuery = e.target.value;
                        this.renderProducts('Search Results');
                    });
                    document.getElementById('contact-fab').addEventListener('click', () => this.openContactModal());
                },
                openContactModal() {
                    const container = document.getElementById('contact-modal');
                    const { store_name, owner_name, store_phone } = app.db.settings;
                    container.innerHTML = `
                        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm text-center relative">
                            <button onclick="app.methods.toggleModal(false, 'contact-modal')" class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100"><i data-lucide="x"></i></button>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Contact Us</h2>
                            <div class="space-y-3 text-left">
                                <p><strong>Shop:</strong> ${store_name || 'N/A'}</p>
                                <p><strong>Owner:</strong> ${owner_name || 'N/A'}</p>
                                <p><strong>Mobile:</strong> <a href="tel:${store_phone}" class="text-blue-600 hover:underline">${store_phone || 'N/A'}</a></p>
                            </div>
                        </div>`;
                    this.toggleModal(true, 'contact-modal');
                    lucide.createIcons();
                },
                getProductByVariantId(variantId) {
                    for (const product of app.db.products) {
                        const variant = product.variants.find(v => v.id == variantId);
                        if (variant) return { ...product, variant };
                    }
                    return null;
                },
                saveCart() { localStorage.setItem('saritaCart', JSON.stringify(app.state.cart)); },
                loadCart() {
                    const savedCart = localStorage.getItem('saritaCart');
                    if (savedCart) app.state.cart = JSON.parse(savedCart);
                },
                addToCart(variantId, quantity = 1) {
                    const product = this.getProductByVariantId(variantId);
                    if (!product || product.variant.stock < quantity) { this.showToast('This item is out of stock.', 'error'); return; }
                    const existingItem = app.state.cart.find(item => item.variantId === variantId);
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        app.state.cart.push({ variantId: variantId, quantity });
                    }
                    this.showToast(`${product.name} (${product.variant.unit}) added to cart!`);
                    this.saveCart();
                    this.updateCartCount();
                    this.updateAllActionButtons(variantId);
                    if(document.getElementById('page-detail').classList.contains('active')){
                         this.renderProductDetailVariants(product);
                    }
                },
                updateCartQuantity(variantId, change) {
                    const itemIndex = app.state.cart.findIndex(item => item.variantId == variantId);
                    if (itemIndex > -1) {
                        app.state.cart[itemIndex].quantity += change;
                        if (app.state.cart[itemIndex].quantity <= 0) {
                            app.state.cart.splice(itemIndex, 1);
                        }
                    }
                    this.saveCart();
                    this.updateCartCount();
                    this.updateAllActionButtons(variantId);
                     if(document.getElementById('page-detail').classList.contains('active')){
                         this.renderProductDetailVariants(this.getProductByVariantId(variantId));
                    }
                    if (document.getElementById('checkout-modal-overlay')?.classList.contains('hidden') === false) {
                        this.renderCheckoutStep();
                    }
                },
                updateCartCount() {
                    document.getElementById("cart-count").textContent = app.state.cart.reduce((sum, item) => sum + item.quantity, 0);
                },
                toggleModal(show, modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) modal.classList.toggle('hidden', !show);
                },
                toggleCartModal(show) {
                    const container = document.getElementById('checkout-modal-overlay');
                    if(show) {
                        container.innerHTML = `
                            <div class="fixed bottom-0 left-0 right-0 h-[90vh] bg-white rounded-t-2xl shadow-2xl flex flex-col max-w-sm mx-auto">
                                <header class="p-4 border-b border-gray-200"><div class="flex justify-between items-center mb-2"><h2 id="checkout-title" class="text-lg font-bold">Your Cart</h2><button onclick="app.methods.toggleCartModal(false)"><i data-lucide="x"></i></button></div><div id="checkout-progress" class="flex space-x-2"></div></header>
                                <main class="flex-grow overflow-y-auto p-4"><div id="checkout-step-1" class="checkout-step"></div><div id="checkout-step-2" class="checkout-step"></div><div id="checkout-step-3" class="checkout-step"></div></main>
                                <footer class="p-4 bg-white border-t border-gray-200" id="checkout-footer"></footer>
                            </div>`;
                        this.resetCheckout();
                        this.renderCheckoutStep();
                    }
                    this.toggleModal(show, 'checkout-modal-overlay');
                    lucide.createIcons();
                },
                showProductDetail(productId) {
                    const product = app.db.products.find(p => p.id === productId);
                    if (!product) return;
                    const detailPage = document.getElementById('page-detail');
                    
                    detailPage.innerHTML = `
                        <div class="h-64 bg-gray-100 relative"><img src="${product.img}" class="w-full h-full object-contain"><button onclick="app.methods.hideProductDetail()" class="absolute top-4 left-4 bg-white p-2 rounded-full shadow"><i data-lucide="chevron-left"></i></button></div>
                        <div class="p-4 space-y-4">
                            <h2 class="text-2xl font-bold">${product.name}</h2>
                            <p class="text-gray-600">${product.description || ''}</p>
                            <h3 class="font-semibold text-lg">Choose Variant</h3>
                            <div id="detail-variants-container" class="space-y-3"></div>
                        </div>`;
                    
                    document.getElementById('page-main').classList.remove('active');
                    detailPage.classList.add('active');
                    this.renderProductDetailVariants(product);
                    lucide.createIcons();
                },
                 renderProductDetailVariants(product) {
                    const container = document.getElementById('detail-variants-container');
                    if (!container) return;
                    container.innerHTML = product.variants.filter(v => v.status === 'Active').map(v => `
                        <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                            <div>
                                <p class="font-semibold">${v.unit}</p>
                                <p class="text-sm font-bold text-green-600">${app.db.settings.currency_symbol || '₹'}${parseFloat(v.sale_price).toFixed(2)}</p>
                            </div>
                            <div id="action-container-detail-${v.id}">${this.getActionButtonHTML(v.id, false, product.id)}</div>
                        </div>`).join('');
                     lucide.createIcons();
                },
                hideProductDetail() {
                    document.getElementById('page-detail').classList.remove('active');
                    document.getElementById('page-main').classList.add('active');
                },
                showToast(message, type = "success") {
                    const toastContainer = document.getElementById("toast-notification");
                    const colors = { success: "bg-green-500", error: "bg-red-500", info: "bg-blue-500" };
                    const toast = document.createElement('div');
                    toast.className = `p-4 rounded-lg shadow-lg text-white ${colors[type] || 'bg-gray-800'}`;
                    toast.textContent = message;
                    toastContainer.appendChild(toast);
                    setTimeout(() => toast.classList.add('show'), 10);
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                },
                resetCheckout() { app.state.checkout = { step: 1, name: '', phone: '', address: '' }; },
                renderCheckoutStep() {
                    const step = app.state.checkout.step;
                    const titles = ["Your Cart", "Your Details", "Order Summary"];
                    document.getElementById('checkout-title').innerText = titles[step - 1];
                    const progressContainer = document.getElementById('checkout-progress');
                    if(progressContainer) progressContainer.innerHTML = Array.from({length: 3}, (_, i) => `<div class="h-1.5 flex-1 rounded-full ${i < step ? 'bg-green-500' : 'bg-gray-200'}"></div>`).join('');
                    document.querySelectorAll('.checkout-step').forEach((el, index) => el.classList.toggle('active', index + 1 === step));
                    this.renderCheckoutStepContent(step);
                    this.renderCheckoutFooter(step);
                },
                renderCheckoutStepContent(step) {
                    const stepContainer = document.getElementById(`checkout-step-${step}`);
                    if (!stepContainer) return;
                    let content = '';
                    switch (step) {
                        case 1: 
                            if (app.state.cart.length === 0) {
                                content = `<div class="text-center py-12 text-gray-500"><i data-lucide="shopping-cart" class="mx-auto h-12 w-12"></i><p class="mt-2">Your cart is empty.</p></div>`;
                            } else {
                                content = app.state.cart.map(item => {
                                    const product = this.getProductByVariantId(item.variantId); if (!product) return '';
                                    return `<div class="flex items-center justify-between py-3 border-b border-gray-200"><div class="flex items-center gap-4"><img src="${product.img}" class="w-16 h-16 rounded object-contain border border-gray-200 p-1"><div><p class="font-semibold">${product.name} (${product.variant.unit})</p><p class="text-sm text-gray-500">${app.db.settings.currency_symbol || '₹'}${parseFloat(product.variant.sale_price).toFixed(2)}</p></div></div><div class="flex items-center space-x-3 bg-gray-100 font-bold rounded-full"><button onclick="app.methods.updateCartQuantity(${item.variantId}, -1)" class="p-2"><i data-lucide="minus" class="w-4 h-4"></i></button><span>${item.quantity}</span><button onclick="app.methods.updateCartQuantity(${item.variantId}, 1)" class="p-2"><i data-lucide="plus" class="w-4 h-4"></i></button></div></div>`;
                                }).join('');
                            }
                            break;
                        case 2:
                            content = `<div class="space-y-4"><h3 class="font-semibold text-lg">Your Details</h3><div><label class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="checkout-customer-name" value="${app.state.checkout.name}" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"></div><div><label class="block text-sm font-medium text-gray-700">Phone Number</label><input type="tel" id="checkout-customer-phone" value="${app.state.checkout.phone}" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" placeholder="e.g., 919876543210"></div><div><label class="block text-sm font-medium text-gray-700">Delivery Address</label><textarea id="checkout-customer-address" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">${app.state.checkout.address}</textarea><button onclick="app.methods.getLocation()" class="mt-2 text-sm text-blue-600 hover:underline flex items-center gap-1"><i data-lucide="map-pin" class="h-4 w-4"></i> Fetch Current Location</button></div></div>`;
                            break;
                        case 3:
                            let subtotal = app.state.cart.reduce((sum, item) => sum + (item.quantity * this.getProductByVariantId(item.variantId).variant.sale_price), 0);
                            content = `<div class="space-y-4"><h3 class="font-semibold text-lg">Review Your Order</h3><div><h4 class="font-semibold mb-2">Details</h4><div class="bg-gray-100 p-3 rounded-lg border border-gray-200 text-sm space-y-1"><p><strong>Name:</strong> ${app.state.checkout.name}</p><p><strong>Phone:</strong> ${app.state.checkout.phone}</p><p><strong>Address:</strong> ${app.state.checkout.address}</p></div></div><div><h4 class="font-semibold mb-2">Items</h4><div class="border-t border-gray-200 pt-2 space-y-2">${app.state.cart.map(item => `<div class="flex justify-between text-sm"><span>${this.getProductByVariantId(item.variantId).name} x${item.quantity}</span><span>${app.db.settings.currency_symbol || '₹'}${(item.quantity * this.getProductByVariantId(item.variantId).variant.sale_price).toFixed(2)}</span></div>`).join('')}</div></div><div class="border-t border-gray-200 pt-2 space-y-2"><div class="flex justify-between font-bold text-lg"><span>Total</span><span>${app.db.settings.currency_symbol || '₹'}${subtotal.toFixed(2)}</span></div></div></div>`;
                            break;
                    }
                    stepContainer.innerHTML = content;
                    lucide.createIcons();
                },
                renderCheckoutFooter(step) {
                    const footer = document.getElementById('checkout-footer');
                    let backButton = step > 1 ? `<button onclick="app.methods.changeCheckoutStep(-1)" class="bg-gray-200 text-gray-700 py-3 px-6 rounded-full font-bold">Back</button>` : '';
                    let nextButton = '';
                    if (step === 1) nextButton = app.state.cart.length > 0 ? `<button onclick="app.methods.changeCheckoutStep(1)" class="bg-green-500 text-white py-3 px-6 rounded-full font-bold flex-grow">Enter Details</button>` : '';
                    else if (step === 2) nextButton = `<button onclick="app.methods.changeCheckoutStep(1)" class="bg-green-500 text-white py-3 px-6 rounded-full font-bold flex-grow">Review Order</button>`;
                    else if (step === 3) nextButton = `<button onclick="app.methods.handlePlaceOrder()" class="bg-green-500 text-white py-3 px-6 rounded-full font-bold flex-grow flex items-center justify-center gap-2"><i data-lucide="send"></i>Place Order</button>`;
                    footer.innerHTML = `<div class="flex gap-2">${backButton}${nextButton}</div>`;
                    lucide.createIcons();
                },
                changeCheckoutStep(direction) {
                    if (direction > 0 && app.state.checkout.step === 2) {
                        app.state.checkout.name = document.getElementById('checkout-customer-name').value.trim();
                        app.state.checkout.phone = document.getElementById('checkout-customer-phone').value.trim();
                        app.state.checkout.address = document.getElementById('checkout-customer-address').value.trim();
                        if (!app.state.checkout.name || !app.state.checkout.phone || !app.state.checkout.address) { this.showToast("Please fill in all your details.", "error"); return; }
                    }
                    app.state.checkout.step += direction;
                    this.renderCheckoutStep();
                },
                async getLocation() {
                    if (LOCATIONIQ_API_KEY === 'pk.YOUR_LOCATIONIQ_API_KEY' || !LOCATIONIQ_API_KEY) { 
                        this.showToast('Location Service not configured.', 'error'); return;
                    }
                    this.showToast('Fetching location...', 'info');
                    try {
                        if (!navigator.geolocation) { throw new Error('Geolocation is not supported by your browser.'); }
                        const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 8000 }));
                        const { latitude, longitude } = position.coords;
                        const response = await fetch(`https://us1.locationiq.com/v1/reverse.php?key=${LOCATIONIQ_API_KEY}&lat=${latitude}&lon=${longitude}&format=json`);
                        if (!response.ok) throw new Error('Failed to fetch address from API.');
                        const data = await response.json();
                        document.getElementById('checkout-customer-address').value = data.display_name || 'Could not determine address';
                        this.showToast('Location fetched!', 'success');
                    } catch (error) {
                        let message = 'Could not get location. Trying IP-based fallback.';
                        if (error && error.code) {
                            switch (error.code) {
                                case 1: message = "Location permission denied."; break;
                                case 2: message = "Location information is unavailable."; break;
                                case 3: message = "Location request timed out."; break;
                            }
                        } else if (error && error.message && error.message.toLowerCase().includes('policy')) {
                            message = "Location is disabled by browser policy.";
                        }
                        this.showToast(message, 'error');
                        console.error("Geolocation Error:", error);
                        
                        try {
                            const ipResponse = await fetch('https://ipapi.co/json/');
                            if(!ipResponse.ok) throw new Error("IP lookup failed");
                            const ipData = await ipResponse.json();
                            const fallbackAddress = `${ipData.city}, ${ipData.region}, ${ipData.country_name}`;
                             document.getElementById('checkout-customer-address').value = fallbackAddress;
                             this.showToast('Approximate location found via IP!', 'info');
                        } catch (ipError){
                             this.showToast('Could not determine location. Please enter manually.', 'error');
                             console.error("IP Location Error:", ipError);
                        }
                    }
                },
                async handlePlaceOrder() {
                    this.showToast('Placing your order...', 'info');
                    const { name, phone, address } = app.state.checkout;
                    const { data: customer, error: customerError } = await supabaseClient.from('customers').upsert({ phone, name }, { onConflict: 'phone' }).select().single();
                    if (customerError) { console.error(customerError); this.showToast('Error saving customer info.', 'error'); return; }
                    const total = app.state.cart.reduce((sum, item) => sum + (item.quantity * this.getProductByVariantId(item.variantId).variant.sale_price), 0);
                    const orderPayload = { customer_id: customer.id, customer_details: { name, phone, address }, total, status: 'Pending' };
                    const { data: order, error: orderError } = await supabaseClient.from('orders').insert(orderPayload).select().single();
                    if (orderError) { console.error(orderError); this.showToast('Could not create order.', 'error'); return; }
                    const orderItemsPayload = app.state.cart.map(item => ({ order_id: order.id, variant_id: item.variantId, quantity: item.quantity, price_at_purchase: this.getProductByVariantId(item.variantId).variant.sale_price, item_details: { name: this.getProductByVariantId(item.variantId).name, unit: this.getProductByVariantId(item.variantId).variant.unit } }));
                    const { error: itemsError } = await supabaseClient.from('order_items').insert(orderItemsPayload);
                    if (itemsError) { console.error(itemsError); this.showToast('Error saving order items.', 'error'); return; }
                    this.showToast('Order placed successfully! Thank you.', 'success');
                    app.state.cart = [];
                    this.saveCart();
                    this.renderAll();
                    this.toggleCartModal(false);
                },
                openOrderHistoryLookup() {
                    const container = document.getElementById('order-history-lookup-modal');
                    container.innerHTML = `<div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm relative"><button onclick="app.methods.toggleModal(false, 'order-history-lookup-modal')" class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100"><i data-lucide="x"></i></button><h2 class="text-2xl font-bold text-center text-gray-800 mb-2">My Orders</h2><p class="text-center text-sm text-gray-500 mb-6">Enter your phone number to find your past orders.</p><form id="order-history-lookup-form"><div class="mb-4"><label for="order-history-phone" class="block text-gray-700 text-sm font-bold mb-2">Phone Number</label><input type="tel" id="order-history-phone" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required placeholder="e.g. 919876543210"></div><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full w-full">Find My Orders</button></form></div>`;
                    document.getElementById('order-history-lookup-form').onsubmit = (e) => this.handleOrderHistoryLookup(e);
                    this.toggleModal(true, 'order-history-lookup-modal');
                    lucide.createIcons();
                },
                async handleOrderHistoryLookup(e) {
                    e.preventDefault();
                    const phone = document.getElementById('order-history-phone').value; if (!phone) return;
                    this.showToast('Searching for your orders...', 'info');
                    const { data: orders, error } = await supabaseClient.from('orders').select('*, order_items(*)').eq('customer_details->>phone', phone).order('created_at', { ascending: false });
                    if (error) { this.showToast('Could not find orders.', 'error'); console.error(error); return; }
                    this.toggleModal(false, 'order-history-lookup-modal');
                    if (orders.length > 0) {
                        this.renderOrderHistory(orders);
                        this.toggleModal(true, 'order-history-display-modal');
                    } else { this.showToast('No orders found for that phone number.', 'info'); }
                },
                renderOrderHistory(orders) {
                    const container = document.getElementById('order-history-display-modal');
                    container.innerHTML = `<div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"><header class="p-4 border-b border-gray-200 flex justify-between items-center"><h2 class="text-xl font-bold text-gray-800">Your Order History</h2><button onclick="app.methods.toggleModal(false, 'order-history-display-modal')"><i data-lucide="x"></i></button></header><main class="flex-grow p-4 overflow-y-auto space-y-4">${orders.map(order => `<div class="bg-gray-50 border border-gray-200 p-4 rounded-lg"><div class="flex justify-between items-start border-b border-gray-200 pb-2 mb-2"><div><p class="font-bold">Order #${order.id}</p><p class="text-xs text-gray-500">${new Date(order.created_at).toLocaleDateString()}</p></div><span class="px-2 py-1 text-xs rounded-full ${order.status === 'Delivered' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${order.status}</span></div><div class="text-sm space-y-1 mb-3">${order.order_items.map(item => `<div class="flex justify-between"><span>${item.item_details.name} (x${item.quantity})</span><span>${app.db.settings.currency_symbol}${(item.price_at_purchase * item.quantity).toFixed(2)}</span></div>`).join('')}</div><div class="flex justify-between items-center border-t border-gray-200 pt-2"><span class="font-bold text-lg">Total: ${app.db.settings.currency_symbol}${parseFloat(order.total).toFixed(2)}</span></div></div>`).join('')}</main></div>`;
                    lucide.createIcons();
                },
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.methods.init());
    </script>
</body>
</html>

