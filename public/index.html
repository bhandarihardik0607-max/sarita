import React, { useState, useReducer, useEffect, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { ShoppingCart, Tag, Filter, MapPin, CheckCircle, XCircle, ChevronLeft, ChevronRight, User, Phone, Loader2, ArrowRight, Package } from 'lucide-react';

// --- Global Constants and Helpers ---

// Theme Change: Switching to Soft Light Mode with Teal/Mint Accent
const ACCENT_COLOR = 'text-teal-600';
const ACCENT_BG = 'bg-teal-500';

// Mock Data for Products (Updated with description and variants)
const MOCK_PRODUCTS = [
  { 
    id: 1, name: 'Organic Red Lentils', category: 'Staples', imageUrl: 'https://placehold.co/400x400/374151/EAB308?text=Lentils',
    description: "Sustainably grown and carefully processed, these red lentils cook quickly and are perfect for dals, soups, and stews. Rich in protein and fiber.",
    variants: [{ unit: '1 Kg', price: 120.00 }, { unit: '500g', price: 65.00 }]
  },
  { 
    id: 2, name: 'Hand-Milled Atta', category: 'Staples', imageUrl: 'https://placehold.co/400x400/374151/EAB308?text=Atta',
    description: "Finely ground whole wheat flour, traditionally milled for maximum freshness. Ideal for soft, fluffy rotis and parathas.",
    variants: [{ unit: '1 Kg', price: 60.00 }, { unit: '5 Kg', price: 250.00 }, { unit: '10 Kg', price: 480.00 }]
  },
  { 
    id: 3, name: 'Premium Jasmine Tea', category: 'Beverages', imageUrl: 'https://placehold.co/400x400/374151/EAB308?text=Tea',
    description: "A fragrant blend of green tea leaves and jasmine blossoms. Light, floral, and perfect for an evening unwind.",
    variants: [{ unit: '100g Pack', price: 349.50 }]
  },
  { 
    id: 4, name: 'Artisan Dark Chocolate', category: 'Snacks', imageUrl: 'https://placehold.co/400x400/374151/EAB308?text=Chocolate', 
    description: "70% cocoa solid, rich and intense flavor profile.", 
    variants: [{ unit: '100g Bar', price: 199.00 }] 
  },
  { 
    id: 5, name: 'Fresh Eucalyptus Oil', category: 'Household', imageUrl: 'https://placehold.co/400x400/374151/EAB308?text=Oil', 
    description: "Pure, concentrated oil for cleaning, diffusion, or therapeutic use.", 
    variants: [{ unit: '100ml', price: 450.00 }] 
  },
  { 
    id: 6, name: 'Assorted Gourmet Nuts', category: 'Snacks', imageUrl: 'https://placehold.co/400x400/374151/EAB308?text=Nuts', 
    description: "A healthy mix of almonds, cashews, and walnuts. Perfect for a quick energy boost.", 
    variants: [{ unit: '200g Pack', price: 300.00 }, { unit: '400g Pack', price: 599.00 }] 
  },
  { 
    id: 7, name: 'Dishwashing Gel', category: 'Household', imageUrl: 'https://placehold.co/400x400/374151/EAB308?text=Dishwash', 
    description: "High foaming, concentrated gel for superior cleaning power.", 
    variants: [{ unit: '500ml Bottle', price: 95.00 }, { unit: '1L Refill', price: 170.00 }] 
  },
  { 
    id: 8, name: 'Basmati Rice', category: 'Staples', imageUrl: 'https://placehold.co/400x400/374151/EAB308?text=Rice', 
    description: "Extra-long grain, aromatic Basmati rice, aged for perfection.", 
    variants: [{ unit: '5 Kg', price: 400.00 }, { unit: '10 Kg', price: 750.00 }] 
  },
];

const CATEGORIES = ['All', ...new Set(MOCK_PRODUCTS.map(p => p.category))];
const PROMO_CODES = {
  HIMANSHU20: { type: 'FLAT', value: 20.00, description: '$20 Flat Discount' },
};

// Local Storage Keys
const LS_CART_KEY = 'sarita_cart';
const LS_SPIN_KEY = 'sarita_spun_today';

// --- Reducer and Initial State ---
// Cart items now use a composite ID (baseId_variantIndex) and store variant details.
const initialState = {
  cartItems: [], // { id: compositeId, name: 'Product Name (Variant)', price: P, quantity: Q, baseProductId: B }
  discount: { type: 'NONE', value: 0, description: '' },
  hasSpun: false,
};

const cartReducer = (state, action) => {
  let newCartItems;
  switch (action.type) {
    case 'LOAD_STATE':
      return {
        ...state,
        cartItems: action.payload.cartItems || [],
        hasSpun: action.payload.hasSpun || false,
      };

    case 'ADD_ITEM':
      // action.payload is the new unique item (variant) to add
      const existingItemIndex = state.cartItems.findIndex(item => item.id === action.payload.id);
      
      if (existingItemIndex > -1) {
        // Item/Variant already exists, just increase quantity
        newCartItems = state.cartItems.map((item, index) =>
          index === existingItemIndex
            ? { ...item, quantity: item.quantity + action.payload.quantity } // Use payload quantity for modularity
            : item
        );
      } else {
        // New item/variant
        newCartItems = [...state.cartItems, action.payload];
      }
      return { ...state, cartItems: newCartItems };

    case 'UPDATE_QUANTITY':
      newCartItems = state.cartItems.map(item =>
        item.id === action.payload.id
          ? { ...item, quantity: action.payload.quantity }
          : item
      ).filter(item => item.quantity > 0);
      return { ...state, cartItems: newCartItems };

    case 'APPLY_DISCOUNT':
      // Logic handled outside, ensures clean state update
      return { ...state, discount: action.payload };

    case 'SET_SPUN':
      return { ...state, hasSpun: action.payload };

    case 'CLEAR_CART':
      return { ...state, cartItems: [], discount: { type: 'NONE', value: 0, description: '' } };

    default:
      return state;
  }
};

// --- Component 0: Float Input (Moved out for performance) ---

// Input Field with float label and validation icon
const FloatInput = React.memo(({ id, label, value, onChange, icon: Icon, isValid, type = 'text', maxLength }) => {
  return (
    <div className="relative mb-6">
      <input
        type={type} 
        id={id}
        value={value}
        // FIX: Optimized onChange handler for phone number to allow only digits and limit length
        onChange={(e) => {
            const rawValue = e.target.value;
            if (id === 'phone') {
                const digitsOnly = rawValue.replace(/\D/g, ''); // Remove all non-digits
                onChange(digitsOnly.slice(0, 10)); // Set state with max 10 digits
            } else {
                onChange(rawValue);
            }
        }}
        maxLength={maxLength}
        className="block px-2.5 pb-2.5 pt-4 w-full text-sm text-gray-900 bg-transparent rounded-lg border-2 border-gray-400 appearance-none focus:outline-none focus:ring-0 focus:border-teal-600 peer"
        placeholder=" "
      />
      <label
        htmlFor={id}
        className="absolute text-sm text-gray-500 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-white px-2 peer-focus:px-2 peer-focus:text-teal-600 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto"
      >
        {label}
      </label>
      <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
        {value.length > 0 && (
          <AnimatePresence mode="wait">
            {isValid ? (
              <motion.div key="check" initial={{ opacity: 0, scale: 0.8 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.8 }}>
                <CheckCircle className="w-5 h-5 text-green-500" />
              </motion.div>
            ) : (
              <motion.div key="cross" initial={{ opacity: 0, scale: 0.8 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.8 }}>
                <Icon className="w-5 h-5 text-gray-500" />
              </motion.div>
            )}
          </AnimatePresence>
        )}
      </div>
    </div>
  );
});

// --- Component 1: Animated Product Card ---
const ProductCard = React.memo(({ product, onProductClick, currentQuantity, containerRef }) => {
  const cardVariants = {
    initial: { opacity: 0, y: 20 },
    animate: { opacity: 1, y: 0, transition: { duration: 0.5, ease: 'easeOut' } },
    whileHover: { scale: 1.03, boxShadow: "0 10px 20px rgba(0, 0, 0, 0.1)" }
  };
  
  // NOTE: Direct Add/Remove buttons removed from card to enforce modal use for variant selection.

  return (
    <motion.div
      id={`product-${product.id}`}
      variants={cardVariants}
      initial="initial"
      animate="animate"
      whileHover="whileHover"
      onClick={() => onProductClick(product)} // New click handler to open modal
      className="p-4 bg-white rounded-xl shadow-xl flex flex-col justify-between h-full border-t-4 border-teal-500/20 transition-all duration-300 cursor-pointer"
    >
      <div className="relative">
        <img
          src={product.imageUrl}
          alt={product.name}
          className="w-full h-40 object-cover rounded-lg mb-4 opacity-70 hover:opacity-100 transition duration-300"
          onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/400x400/374151/EAB308?text=Product' }}
        />
        <span className="absolute top-2 left-2 bg-gray-50/70 text-xs font-semibold px-3 py-1 rounded-full text-gray-700 backdrop-blur-sm shadow-md">{product.category}</span>
      </div>
      <div className="flex flex-col flex-grow">
        <h3 className="text-lg font-bold text-gray-900 mb-1">{product.name}</h3>
        {/* Display the price range or first variant price */}
        <p className={`${ACCENT_COLOR} text-2xl font-extrabold mb-4`}>
          â‚¹{product.variants[0].price.toFixed(2)} - {product.variants.length > 1 ? `...` : product.variants[0].unit}
        </p>
      </div>
      
      {/* Button to open detail modal */}
      <motion.button
        whileTap={{ scale: 0.95 }}
        className={`w-full py-2 rounded-lg font-bold uppercase tracking-wider ${ACCENT_BG} text-white hover:bg-teal-600 transition duration-150 flex items-center justify-center`}
      >
        <Package className="w-5 h-5 mr-2" />
        View Details & Variants
      </motion.button>
    </motion.div>
  );
});

// --- Component 2: Animated Category Filter ---
const CategoryFilter = ({ categories, currentCategory, onSelectCategory }) => {
  return (
    <div className="sticky top-0 z-10 py-4 bg-gray-50 shadow-lg">
      <div className="flex overflow-x-auto space-x-3 px-4 sm:px-8 pb-2 scrollbar-hide">
        {categories.map((cat, index) => (
          <motion.button
            key={cat}
            onClick={() => onSelectCategory(cat)}
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ delay: index * 0.1, duration: 0.3 }}
            whileTap={{ scale: 0.95 }}
            className={`flex-shrink-0 px-5 py-2 text-sm font-semibold rounded-full transition-colors duration-200 shadow-md ${
              cat === currentCategory
                ? `${ACCENT_BG} text-white`
                : 'bg-gray-200 text-gray-600 hover:bg-gray-300 hover:text-gray-800'
            }`}
          >
            <Filter className="w-4 h-4 inline mr-1" />
            {cat}
          </motion.button>
        ))}
      </div>
    </div>
  );
};

// --- Component 3: Spin to Win Modal (Simplified for brevity, kept consistent) ---
const SpinToWinModal = ({ isOpen, onClose, dispatch, total, hasSpun }) => {
  const [isSpinning, setIsSpinning] = useState(false);
  const [result, setResult] = useState(null); 
  const [spinDeg, setSpinDeg] = useState(0);

  const discountLevels = [
    { percent: 0, text: "Try Again", color: "text-red-500", weight: 4 },
    { percent: 5, text: "5% OFF", color: "text-teal-500", weight: 3 },
    { percent: 10, text: "10% OFF", color: "text-green-600", weight: 2 },
    { percent: 15, text: "15% OFF", color: "text-cyan-600", weight: 1 },
  ];
  const totalWeight = discountLevels.reduce((sum, item) => sum + item.weight, 0);

  const handleSpin = () => {
    if (hasSpun || isSpinning || total === 0) return;

    setIsSpinning(true);

    let randomNum = Math.random() * totalWeight;
    let selectedDiscount = null;
    let cumulativeWeight = 0;

    for (const level of discountLevels) {
      cumulativeWeight += level.weight;
      if (randomNum < cumulativeWeight) {
        selectedDiscount = level;
        break;
      }
    }

    const numSlices = discountLevels.length;
    const sliceAngle = 360 / numSlices;
    const winningIndex = discountLevels.findIndex(d => d.percent === selectedDiscount.percent);

    const newSpinDeg = spinDeg + (360 * 5) + (sliceAngle * winningIndex) + (sliceAngle / 2) + (Math.random() * 30 - 15);

    setSpinDeg(newSpinDeg);
    dispatch({ type: 'SET_SPUN', payload: true });

    setTimeout(() => {
      setIsSpinning(false);
      setResult(selectedDiscount);

      if (selectedDiscount.percent > 0) {
        dispatch({
          type: 'APPLY_DISCOUNT',
          payload: {
            type: 'PERCENT',
            value: selectedDiscount.percent,
            description: `${selectedDiscount.percent}% Spin-to-Win Discount`,
          },
        });
      }
    }, 4000); 
  };

  const getSliceStyle = (index) => {
    const numSlices = discountLevels.length;
    const angle = 360 / numSlices;
    const color = ['bg-red-300', 'bg-teal-300', 'bg-green-300', 'bg-cyan-300'][index % numSlices];
    return {
      clipPath: `polygon(0% 0%, 50% 50%, 0% 100%)`, 
      transform: `rotate(${angle * index}deg) skewY(-20deg)`,
      transformOrigin: '50% 50%',
      backgroundColor: color,
    };
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-gray-800/90 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={onClose}>
      <motion.div
        initial={{ scale: 0.8, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        exit={{ scale: 0.8, opacity: 0 }}
        transition={{ type: 'spring', damping: 20, stiffness: 300 }}
        className="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full border border-teal-500/30"
        onClick={(e) => e.stopPropagation()}
      >
        <h2 className={`text-3xl font-extrabold mb-4 text-center ${ACCENT_COLOR}`}>Spin to Win!</h2>
        <p className="text-gray-600 mb-6 text-center">Spin once per session for a chance to win a discount on your current total (â‚¹{total.toFixed(2)}).</p>

        {/* Spinning Wheel */}
        <div className="relative w-64 h-64 mx-auto mb-8">
          <div className="absolute top-0 left-1/2 -ml-1 h-6 w-3 z-10">
            <div className={`w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-b-[16px] ${ACCENT_COLOR.replace('text-', 'border-b-')}`}></div>
          </div>
          <motion.div
            className="w-full h-full rounded-full border-4 border-teal-500 bg-gray-200 shadow-md relative overflow-hidden"
            animate={{ rotate: spinDeg }}
            transition={{ type: 'spring', duration: 4, bounce: 0.4 }}
          >
            {discountLevels.map((level, index) => (
              <div
                key={index}
                className="absolute inset-0 flex items-center justify-center p-4 text-center"
                style={{
                  ...getSliceStyle(index),
                  transform: `rotate(${360 / discountLevels.length * index}deg)`,
                  transformOrigin: '50% 50%',
                  clipPath: `polygon(50% 50%, 100% 0%, 100% 100%)`, 
                }}
              >
                <div className={`absolute inset-0 bg-opacity-30 flex items-center justify-center`}
                  style={{ transform: `rotate(-${360 / discountLevels.length * index}deg)` }}
                >
                  <p className={`text-xl font-bold -mt-16 ${level.color}`}>{level.text}</p>
                </div>
              </div>
            ))}
            {/* Center Pin */}
            <div className="absolute inset-0 m-auto w-8 h-8 rounded-full bg-gray-100 border-2 border-teal-500 z-20"></div>

          </motion.div>
        </div>

        {result && (
          <motion.p
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            className={`text-2xl font-bold text-center mb-4 ${result.color}`}
          >
            {result.percent > 0 ? `Congratulations! You Won ${result.text}!` : `${result.text}. Better Luck Next Time!`}
          </motion.p>
        )}

        <motion.button
          onClick={handleSpin}
          disabled={hasSpun || isSpinning || total === 0}
          whileTap={{ scale: hasSpun || isSpinning || total === 0 ? 1 : 0.98 }}
          className={`w-full py-3 rounded-lg font-bold transition duration-300 flex items-center justify-center ${ACCENT_BG} text-white disabled:opacity-50 disabled:cursor-not-allowed`}
        >
          {isSpinning ? (
            <Loader2 className="w-5 h-5 mr-2 animate-spin" />
          ) : hasSpun ? (
            <CheckCircle className="w-5 h-5 mr-2" />
          ) : (
            <motion.span initial={{ scale: 1 }} animate={{ scale: [1, 1.05, 1] }} transition={{ repeat: Infinity, duration: 1, ease: "easeInOut" }}>
              SPIN NOW!
            </motion.span>
          )}
        </motion.button>
        <button onClick={onClose} className="mt-4 w-full text-sm text-gray-500 hover:text-gray-800 transition">Close</button>
      </motion.div>
    </div>
  );
};

// --- Component 4: Checkout Form and Geolocation Module ---
const CheckoutForm = ({ state, total, finalTotal, dispatch, setScreen }) => {
  const [customerName, setCustomerName] = useState('');
  const [customerPhone, setCustomerPhone] = useState('');
  const [promoCode, setPromoCode] = useState('');
  const [promoMessage, setPromoMessage] = useState({ text: '', type: 'info' });
  const [locationStatus, setLocationStatus] = useState('idle'); // idle, loading, success, denied
  const [coords, setCoords] = useState(null);
  const [locationErrorMsg, setLocationErrorMsg] = useState(''); 

  // Form Validation State
  const isNameValid = customerName.length > 2;
  const isPhoneValid = customerPhone.match(/^\d{10}$/);

  const handleApplyPromo = () => {
    setPromoMessage({ text: '', type: 'info' });
    const codeData = PROMO_CODES[promoCode.toUpperCase()];

    if (codeData) {
      const currentDiscountValue = state.discount.type === 'PERCENT'
        ? (state.discount.value / 100) * total
        : state.discount.value;

      let newDiscountValue;
      let isBetter = false;

      if (codeData.type === 'FLAT') {
        newDiscountValue = codeData.value;
        if (newDiscountValue > currentDiscountValue) {
          isBetter = true;
        }
      }

      if (isBetter) {
        dispatch({ type: 'APPLY_DISCOUNT', payload: { ...codeData, code: promoCode.toUpperCase() } });
        setPromoMessage({ text: `${codeData.description} Applied! (â‚¹${codeData.value.toFixed(2)})`, type: 'success' });
      } else {
        setPromoMessage({ text: `Promo code applied, but current discount (â‚¹${currentDiscountValue.toFixed(2)}) is better.`, type: 'warning' });
      }
    } else {
      setPromoMessage({ text: 'Invalid promo code.', type: 'error' });
    }
  };

  const handleFetchLocation = () => {
    if (!navigator.geolocation) {
      setLocationStatus('denied');
      setLocationErrorMsg('Geolocation is not supported by your browser.');
      console.error('Geolocation is not supported by your browser');
      return;
    }

    setLocationStatus('loading');
    setLocationErrorMsg('');
    setCoords(null);
    navigator.geolocation.getCurrentPosition(
      (position) => {
        setLocationStatus('success');
        setLocationErrorMsg(''); 
        setCoords({
          lat: position.coords.latitude.toFixed(4),
          lon: position.coords.longitude.toFixed(4)
        });
      },
      (error) => {
        setLocationStatus('denied');
        
        console.error('Geolocation failed.', { code: error.code, message: error.message });

        // WORKAROUND FOR PERMISSIONS POLICY BLOCKING GEOLOCATION IN IFRAME ENVIRONMENTS
        if (error.code === error.PERMISSION_DENIED && error.message.includes('permissions policy')) {
            console.warn('Geolocation blocked by permissions policy. Setting status to SUCCESS for demo purposes.');
            setLocationStatus('success');
            setLocationErrorMsg('Location access blocked by browser/environment policy. Assuming a default location for order placement.');
            setCoords({ lat: 28.7041, lon: 77.1025 }); // Set a default location for demo
            return;
        }
        // END WORKAROUND

        let message;
        if (error.code === error.PERMISSION_DENIED) {
            message = 'Access Denied: You blocked location permission.';
        } else if (error.code === error.POSITION_UNAVAILABLE) {
            message = 'Position Unavailable: Cannot determine your location.';
        } else if (error.code === error.TIMEOUT) {
            message = 'Location Request Timed Out.';
        } else {
            message = 'Access Denied: Please check browser permissions.';
        }
        setLocationErrorMsg(message);
        setCoords(null);
      },
      { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
    );
  };

  const handlePlaceOrder = () => {
    if (!isNameValid || !isPhoneValid || locationStatus !== 'success') {
      alert("Please complete the form and secure your location before placing the order.");
      return;
    }

    console.log("Order Placed:", {
      name: customerName,
      phone: customerPhone,
      cart: state.cartItems,
      discount: state.discount,
      total: finalTotal,
      location: coords,
    });

    dispatch({ type: 'CLEAR_CART' });
    alert(`Order of â‚¹${finalTotal.toFixed(2)} placed successfully! Thank you, ${customerName}.`);
    setScreen('products'); 
  };

  return (
    <motion.div
      initial={{ opacity: 0, x: 50 }}
      animate={{ opacity: 1, x: 0 }}
      exit={{ opacity: 0, x: 50 }}
      transition={{ duration: 0.5 }}
      className="p-6 bg-white rounded-xl shadow-2xl mt-6 border border-teal-200/50"
    >
      <h3 className={`text-2xl font-bold mb-6 ${ACCENT_COLOR}`}>Checkout Details</h3>

      {/* Customer Info - Uses memoized FloatInput for faster key entry */}
      <FloatInput
        id="name"
        label="Customer Name"
        value={customerName}
        onChange={setCustomerName}
        icon={User}
        isValid={isNameValid}
      />
      <FloatInput
        id="phone"
        label="Customer Phone (10 digits)"
        value={customerPhone}
        onChange={setCustomerPhone}
        icon={Phone}
        isValid={isPhoneValid}
        type="text" 
        maxLength={10}
      />

      {/* Promo Code Input */}
      <motion.div className="mb-6 p-4 bg-teal-50/50 rounded-lg">
        <h4 className="text-lg font-semibold text-gray-800 mb-2 flex items-center"><Tag className="w-5 h-5 mr-2 text-teal-600" /> Have a Promo Code?</h4>
        <div className="flex space-x-2">
          <input
            type="text"
            value={promoCode}
            onChange={(e) => setPromoCode(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleApplyPromo()}
            placeholder="HIMANSHU20"
            className="flex-grow p-3 rounded-lg bg-white border border-gray-300 focus:ring-1 focus:ring-teal-600 focus:border-teal-600 text-gray-800 transition duration-300 shadow-inner shadow-gray-200/50"
          />
          <motion.button
            onClick={handleApplyPromo}
            whileTap={{ scale: 0.95 }}
            className={`p-3 rounded-lg font-bold text-sm ${ACCENT_BG} text-white hover:bg-teal-600 transition duration-150`}
          >
            Apply
          </motion.button>
        </div>
        {promoMessage.text && (
          <motion.p
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            className={`mt-2 text-sm ${promoMessage.type === 'success' ? 'text-green-600' : promoMessage.type === 'warning' ? 'text-orange-600' : 'text-red-600'}`}
          >
            {promoMessage.text}
          </motion.p>
        )}
      </motion.div>

      {/* Geolocation Module */}
      <motion.div className="mb-8 p-4 bg-teal-50/50 rounded-lg border-l-4 border-teal-500">
        <h4 className="text-lg font-semibold text-gray-800 mb-2 flex items-center">
          <MapPin className="w-5 h-5 mr-2 text-teal-600" /> Delivery Location
        </h4>
        <div className="flex items-center justify-between">
          <p className="text-sm">
            {locationStatus === 'idle' && <span className="text-gray-500">Click below to secure your location.</span>}
            {locationStatus === 'loading' && <span className="text-gray-500">Fetching coordinates...</span>}
            {locationStatus === 'success' && <span className="text-green-600">Location Secured âœ“ (Lat: {coords?.lat || '28.7041'}, Lon: {coords?.lon || '77.1025'})</span>}
            {locationStatus === 'denied' && (
              <span className="text-red-500 font-medium">
                {locationErrorMsg || 'Access Denied Ã—. Please allow location access.'}
              </span>
            )}
          </p>
          <motion.button
            onClick={handleFetchLocation}
            disabled={locationStatus === 'loading' || locationStatus === 'success'}
            whileTap={{ scale: 0.95 }}
            className={`px-4 py-2 text-sm rounded-lg font-bold transition duration-150 flex items-center ${ACCENT_BG} text-white disabled:opacity-50 disabled:cursor-not-allowed`}
          >
            {locationStatus === 'loading' ? (
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            ) : locationStatus === 'success' ? (
              <CheckCircle className="w-4 h-4 mr-1" />
            ) : (
              <MapPin className="w-4 h-4 mr-1" />
            )}
            {locationStatus === 'success' ? 'Secured' : 'Fetch Location'}
          </motion.button>
        </div>
      </motion.div>

      {/* Order Summary */}
      <div className="bg-gray-100 p-4 rounded-xl mb-6 shadow-inner">
        <h4 className="text-xl font-bold text-gray-800 mb-3">Order Summary</h4>
        <div className="text-sm space-y-2 text-gray-500">
          <div className="flex justify-between">
            <span>Subtotal:</span>
            <span>â‚¹{total.toFixed(2)}</span>
          </div>
          <motion.div
            initial={{ opacity: 0, y: -5 }}
            animate={{ opacity: state.discount.value > 0 ? 1 : 0, y: state.discount.value > 0 ? 0 : -5 }}
            className="flex justify-between text-green-600 font-semibold"
          >
            <span>Applied Discount:</span>
            <span>- â‚¹{(total - finalTotal).toFixed(2)}</span>
          </motion.div>
          <div className="border-t border-gray-300 pt-3 flex justify-between text-lg font-extrabold">
            <span className="text-gray-900">Final Total:</span>
            <span className={`${ACCENT_COLOR}`}>â‚¹{finalTotal.toFixed(2)}</span>
          </div>
        </div>
      </div>

      {/* Place Order Button */}
      <motion.button
        onClick={handlePlaceOrder}
        disabled={!isNameValid || !isPhoneValid || locationStatus !== 'success' || total === 0}
        whileTap={{ scale: 0.98 }}
        className={`w-full py-4 rounded-lg font-extrabold uppercase tracking-widest transition duration-300 flex items-center justify-center text-xl disabled:opacity-50 disabled:cursor-not-allowed ${ACCENT_BG} text-white hover:bg-teal-600`}
      >
        Order from Sarita General Store
        <ArrowRight className="w-6 h-6 ml-2" />
      </motion.button>
    </motion.div>
  );
};

// --- Component 5: Cart Item List ---
const CartItemList = ({ state, dispatch }) => {
  const cartItemVariants = {
    initial: { opacity: 0, y: 20, x: 50 },
    animate: { opacity: 1, y: 0, x: 0 },
    exit: { opacity: 0, x: 50 },
  };

  const updateQuantity = (id, change) => {
    const item = state.cartItems.find(i => i.id === id);
    if (!item) return;
    const newQuantity = item.quantity + change;
    dispatch({ type: 'UPDATE_QUANTITY', payload: { id, quantity: newQuantity } });
  };

  return (
    <motion.div layout className="space-y-4">
      <AnimatePresence initial={false}>
        {state.cartItems.map((item) => (
          <motion.div
            key={item.id}
            layout
            variants={cartItemVariants}
            initial="initial"
            animate="animate"
            exit="exit"
            transition={{ duration: 0.3 }}
            className="flex items-center p-3 bg-gray-100 rounded-xl shadow-md border-l-4 border-teal-400/70"
          >
            <div className="flex-grow">
              {/* Cart item name now includes the variant unit */}
              <h4 className="text-base font-bold text-gray-900">{item.name} ({item.unit})</h4>
              <p className="text-xs text-gray-500">@ â‚¹{item.price.toFixed(2)}</p>
              <p className={`${ACCENT_COLOR} font-semibold mt-1`}>Total: â‚¹{(item.price * item.quantity).toFixed(2)}</p>
            </div>
            <div className="flex items-center space-x-2 ml-4 flex-shrink-0">
              <motion.button
                onClick={() => updateQuantity(item.id, -1)}
                whileTap={{ scale: 0.9 }}
                className="w-8 h-8 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition"
              >
                <ChevronLeft className="w-5 h-5 mx-auto" />
              </motion.button>
              <span className="font-bold text-lg w-6 text-center text-gray-900">{item.quantity}</span>
              <motion.button
                onClick={() => updateQuantity(item.id, 1)}
                whileTap={{ scale: 0.9 }}
                className={`w-8 h-8 rounded-full bg-gray-200 ${ACCENT_COLOR.replace('text-', 'text-')} hover:bg-gray-300 transition`}
              >
                <ChevronRight className="w-5 h-5 mx-auto" />
              </motion.button>
            </div>
          </motion.div>
        ))}
      </AnimatePresence>
    </motion.div>
  );
};

// --- Component 6: Footer ---
const Footer = () => (
  <footer className="bg-white border-t border-teal-200/50 p-6 mt-12 shadow-inner">
    <div className="max-w-7xl mx-auto text-center">
      <h3 className="text-xl font-bold text-gray-800 mb-2">SARITA GENERAL STORE</h3>
      <p className="text-sm text-gray-500 mb-4">FreshFlow Premium E-Commerce Client</p>
      <div className="text-gray-700 font-medium">
        <p>Owner: HIMANSHU VIJAY</p>
        <p>Contact: <a href="tel:7850897714" className={`${ACCENT_COLOR} hover:underline`}>7850897714</a></p>
      </div>
      <p className="text-xs text-gray-400 mt-4">&copy; {new Date().getFullYear()} All rights reserved.</p>
    </div>
  </footer>
);

// --- Component 7: Animated Slideshow ---
const AnimatedSlideshow = () => {
  const slides = [
    { text: "Fresh Produce Delivered Daily", img: "https://placehold.co/800x300/e0f2f1/0f766e?text=FRESH+PRODUCE" },
    { text: "Quality Staples, Guaranteed", img: "https://placehold.co/800x300/ccfbf1/0f766e?text=QUALITY+STAPLES" },
    { text: "Fastest Delivery in Town", img: "https://placehold.co/800x300/f0fdfa/0f766e?text=FAST+DELIVERY" },
  ];
  const [currentSlide, setCurrentSlide] = useState(0);

  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentSlide((prev) => (prev + 1) % slides.length);
    }, 5000); 

    return () => clearInterval(timer);
  }, [slides.length]);

  return (
    <motion.div
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.8 }}
      className="relative w-full h-40 sm:h-64 overflow-hidden rounded-xl shadow-xl mb-8 border border-teal-200/50" // Adjusted height for mobile
    >
      <AnimatePresence initial={false} mode="wait">
        <motion.div
          key={currentSlide}
          initial={{ opacity: 0, x: 200 }}
          animate={{ opacity: 1, x: 0 }}
          exit={{ opacity: 0, x: -200 }}
          transition={{ duration: 0.6, ease: "easeInOut" }}
          className="absolute inset-0"
        >
          <img
            src={slides[currentSlide].img}
            alt={slides[currentSlide].text}
            className="w-full h-full object-cover"
          />
          <div className="absolute inset-0 bg-gray-900/40 flex items-center justify-center p-4 sm:p-6">
            <h2 className="text-2xl sm:text-5xl font-extrabold text-white text-center tracking-wide drop-shadow-lg">
              {slides[currentSlide].text}
            </h2>
          </div>
        </motion.div>
      </AnimatePresence>
      
      {/* Dot Indicators */}
      <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10">
        {slides.map((_, index) => (
          <motion.div
            key={index}
            className={`w-3 h-3 rounded-full cursor-pointer transition-colors duration-300 ${
              index === currentSlide ? ACCENT_BG : 'bg-white/50'
            }`}
            onClick={() => setCurrentSlide(index)}
            whileHover={{ scale: 1.2 }}
          />
        ))}
      </div>
    </motion.div>
  );
};

// --- Component 8: Product Detail Modal with Variants ---
const ProductDetailModal = ({ product, onClose, onAddToCart, containerRef }) => {
    const [selectedVariantIndex, setSelectedVariantIndex] = useState(0);
    const [quantity, setQuantity] = useState(1);
    const selectedVariant = product.variants[selectedVariantIndex];

    const handleAdd = () => {
        if (quantity > 0) {
            
            // Create a unique cart item object based on the selected variant
            const cartItem = {
                id: `${product.id}-${selectedVariantIndex}`, // Composite ID for uniqueness
                name: product.name,
                price: selectedVariant.price,
                unit: selectedVariant.unit,
                quantity: quantity,
                baseProductId: product.id,
            };

            // Trigger the flight animation and state update
            onAddToCart(cartItem);
            onClose();
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-800/90 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={onClose}>
            <motion.div
                initial={{ scale: 0.9, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                exit={{ scale: 0.9, opacity: 0 }}
                transition={{ type: 'spring', damping: 20, stiffness: 300 }}
                className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
                onClick={(e) => e.stopPropagation()}
            >
                <div className="p-6 sm:p-8">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition">
                        <XCircle className="w-7 h-7" />
                    </button>
                    
                    <h2 className={`text-3xl font-extrabold mb-4 ${ACCENT_COLOR}`}>{product.name}</h2>
                    
                    <div className="grid sm:grid-cols-2 gap-6">
                        {/* Image & Description Column */}
                        <div className="space-y-4">
                            <img 
                                src={product.imageUrl} 
                                alt={product.name} 
                                className="w-full h-40 sm:h-56 object-cover rounded-lg shadow-md"
                                onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/400x400/374151/EAB308?text=Product' }}
                            />
                            <p className="text-gray-700 text-sm italic border-l-4 border-teal-300 pl-3">
                                {product.description}
                            </p>
                        </div>

                        {/* Variants & Controls Column */}
                        <div className="space-y-6">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center"><Package className="w-5 h-5 mr-2" /> Select Variant</h3>
                            
                            {/* Variant Selector */}
                            <div className="flex flex-wrap gap-3">
                                {product.variants.map((variant, index) => (
                                    <motion.button
                                        key={index}
                                        onClick={() => setSelectedVariantIndex(index)}
                                        whileTap={{ scale: 0.98 }}
                                        className={`px-4 py-2 rounded-full font-semibold transition duration-200 border-2 text-sm ${
                                            index === selectedVariantIndex
                                                ? `${ACCENT_BG} text-white border-teal-700 shadow-md`
                                                : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200'
                                        }`}
                                    >
                                        {variant.unit}
                                    </motion.button>
                                ))}
                            </div>

                            {/* Price and Quantity */}
                            <div className="p-4 bg-teal-50 rounded-lg border-l-4 border-teal-500">
                                <p className="text-gray-600 font-medium text-sm">Unit Price:</p>
                                <p className={`${ACCENT_COLOR} text-3xl sm:text-4xl font-extrabold mb-3 transition-colors duration-200`}>
                                    â‚¹{selectedVariant.price.toFixed(2)}
                                </p>
                                <p className="text-gray-800 text-lg font-semibold">Quantity:</p>
                                <div className="flex items-center space-x-3 mt-2">
                                    <motion.button
                                        onClick={() => setQuantity(q => Math.max(1, q - 1))}
                                        whileTap={{ scale: 0.9 }}
                                        className="w-10 h-10 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition"
                                    >
                                        <ChevronLeft className="w-5 h-5 mx-auto" />
                                    </motion.button>
                                    <input 
                                        type="number"
                                        min="1"
                                        value={quantity}
                                        onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                                        className="w-16 text-center text-xl font-bold border-b-2 border-teal-500 focus:outline-none focus:border-teal-700 text-gray-900"
                                    />
                                    <motion.button
                                        onClick={() => setQuantity(q => q + 1)}
                                        whileTap={{ scale: 0.9 }}
                                        className={`w-10 h-10 rounded-full ${ACCENT_BG} text-white hover:bg-teal-600 transition`}
                                    >
                                        <ChevronRight className="w-5 h-5 mx-auto" />
                                    </motion.button>
                                </div>
                            </div>
                            
                            {/* Total and Add Button */}
                            <div className="border-t border-gray-200 pt-4">
                                <p className="flex justify-between text-lg font-semibold text-gray-700 mb-2">
                                    <span>Subtotal:</span>
                                    <span className="text-gray-900">â‚¹{(selectedVariant.price * quantity).toFixed(2)}</span>
                                </p>
                                <motion.button
                                    onClick={handleAdd}
                                    whileTap={{ scale: 0.98 }}
                                    className={`w-full py-3 rounded-lg font-extrabold uppercase tracking-wider ${ACCENT_BG} text-white hover:bg-teal-600 transition duration-150 flex items-center justify-center`}
                                >
                                    <ShoppingCart className="w-5 h-5 mr-2" />
                                    Add {quantity} Item(s) to Cart
                                </motion.button>
                            </div>

                        </div>
                    </div>
                </div>
            </motion.div>
        </div>
    );
};


// --- Main App Component ---

const App = () => {
  const [state, dispatch] = useReducer(cartReducer, initialState);
  const [currentCategory, setCurrentCategory] = useState('All');
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [isSpinModalOpen, setIsSpinModalOpen] = useState(false);
  const [screen, setScreen] = useState('products'); 
  const [selectedProductForDetail, setSelectedProductForDetail] = useState(null); 

  const containerRef = React.useRef(null);

  // 1. Local Storage Management (Load and Save)
  useEffect(() => {
    try {
      const storedCart = localStorage.getItem(LS_CART_KEY);
      const storedSpun = localStorage.getItem(LS_SPIN_KEY) === 'true';
      if (storedCart) {
        dispatch({
          type: 'LOAD_STATE',
          payload: {
            cartItems: JSON.parse(storedCart),
            hasSpun: storedSpun
          }
        });
      }
    } catch (e) {
      console.error("Could not load state from Local Storage:", e);
    }
  }, []); 

  useEffect(() => {
    try {
      localStorage.setItem(LS_CART_KEY, JSON.stringify(state.cartItems));
      localStorage.setItem(LS_SPIN_KEY, state.hasSpun.toString());
    } catch (e) {
      console.error("Could not save state to Local Storage:", e);
    }
  }, [state.cartItems, state.hasSpun]);

  // --- Calculations ---
  const subtotal = state.cartItems.reduce((acc, item) => acc + item.price * item.quantity, 0);

  const calculateFinalTotal = useCallback(() => {
    let discountAmount = 0;

    if (state.discount.type === 'PERCENT') {
      discountAmount = (state.discount.value / 100) * subtotal;
    } else if (state.discount.type === 'FLAT') {
      discountAmount = state.discount.value;
    }

    discountAmount = Math.min(discountAmount, subtotal);

    return subtotal - discountAmount;
  }, [subtotal, state.discount]);

  const finalTotal = calculateFinalTotal();

  // --- Handlers ---
  const handleAddToCart = (cartItem) => {
    // FIX: Dispatch immediately for instant UI update
    dispatch({ type: 'ADD_ITEM', payload: cartItem });
    setIsCartOpen(true); // Open cart sidebar

    // 1. Trigger the flight animation effect (visual only)
    const productElement = containerRef.current.querySelector(`#product-${cartItem.baseProductId}`);
    const cartIconElement = document.getElementById('cart-icon-target');

    if (productElement && cartIconElement) {
      const { left: startX, top: startY, width } = productElement.getBoundingClientRect();
      const { left: endX, top: endY } = cartIconElement.getBoundingClientRect();

      const flyingItem = document.createElement('div');
      flyingItem.style.cssText = `
        position: fixed;
        top: ${startY + width / 2}px;
        left: ${startX + width / 2}px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: ${ACCENT_BG.replace('bg-', '#')};
        z-index: 1000;
        pointer-events: none;
        transition: all 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      `;
      document.body.appendChild(flyingItem);

      setTimeout(() => {
        flyingItem.style.top = `${endY}px`;
        flyingItem.style.left = `${endX}px`;
        flyingItem.style.opacity = '0';
        flyingItem.style.transform = 'scale(0.5)';
      }, 50);

      setTimeout(() => {
        document.body.removeChild(flyingItem);
      }, 700);
    }
  };


  const filteredProducts = MOCK_PRODUCTS.filter(product =>
    currentCategory === 'All' || product.category === currentCategory
  );

  return (
    <div className="min-h-screen bg-gray-50 font-sans antialiased text-gray-900 overflow-x-hidden">
      {/* Header */}
      <motion.header
        initial={{ y: -100 }}
        animate={{ y: 0 }}
        transition={{ type: 'spring', stiffness: 100 }}
        className="sticky top-0 z-40 bg-white shadow-lg border-b border-teal-200/50"
      >
        <div className="max-w-7xl mx-auto px-4 sm:px-8 py-3 sm:py-4 flex justify-between items-center">
          <h1 className="text-xl sm:text-3xl font-black tracking-widest text-gray-900">
            <span className={ACCENT_COLOR.replace('text-', '')}>SARITA</span> STORE
          </h1>

          <div className="flex items-center space-x-3 sm:space-x-4">
            {/* Spin to Win Button */}
            <motion.button
              onClick={() => setIsSpinModalOpen(true)}
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              className={`p-2 sm:p-3 rounded-full font-bold transition duration-300 shadow-lg flex items-center text-xs sm:text-sm ${ACCENT_BG} text-white`}
            >
              <Tag className="w-4 h-4 sm:w-5 sm:h-5 mr-1" />
              <span className="hidden sm:inline">Spin & Win</span>
            </motion.button>

            {/* Cart Icon */}
            <motion.button
              id="cart-icon-target"
              onClick={() => setIsCartOpen(!isCartOpen)}
              whileHover={{ scale: 1.1 }}
              whileTap={{ scale: 0.9 }}
              className="relative p-2 sm:p-3 rounded-full bg-gray-100 hover:bg-gray-200 transition duration-150 text-gray-800"
            >
              <ShoppingCart className={`w-5 h-5 sm:w-6 sm:h-6 ${ACCENT_COLOR}`} />
              <AnimatePresence>
                {state.cartItems.length > 0 && (
                  <motion.div
                    key="cart-count"
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    exit={{ scale: 0 }}
                    className={`absolute -top-1 -right-1 w-5 h-5 flex items-center justify-center rounded-full text-xs font-bold text-white ${ACCENT_BG}`}
                  >
                    {state.cartItems.length}
                  </motion.div>
                )}
              </AnimatePresence>
            </motion.button>
          </div>
        </div>
      </motion.header>

      <main className="max-w-7xl mx-auto px-4 sm:px-8 pt-4 sm:pt-8 pb-16 relative flex">
        {/* Main Content Area - Removed lg:mr-80 from this div for better mobile flow */}
        <div className="flex-grow transition-all duration-300">
          {screen === 'products' && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5 }}
            >
              {/* Animated Slideshow Component */}
              <AnimatedSlideshow />

              <h2 className="text-2xl sm:text-4xl font-extrabold text-gray-900 mb-4 sm:mb-6">Premium Groceries, Freshly Sourced.</h2>

              {/* Category Filter */}
              <CategoryFilter
                categories={CATEGORIES}
                currentCategory={currentCategory}
                onSelectCategory={setCurrentCategory}
              />

              {/* Product Grid - Responsive Grid: 1-col on small, 2/3 on larger */}
              <motion.div
                ref={containerRef}
                className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8 mt-6"
                variants={{
                  visible: { transition: { staggerChildren: 0.05 } }
                }}
                initial="initial"
                animate="visible"
              >
                <AnimatePresence>
                  {filteredProducts.map(product => {
                    const cartItem = state.cartItems.find(item => item.baseProductId === product.id);

                    return (
                      <ProductCard
                        key={product.id}
                        product={product}
                        onProductClick={setSelectedProductForDetail} 
                        containerRef={containerRef}
                      />
                    );
                  })}
                </AnimatePresence>
              </motion.div>
            </motion.div>
          )}

          {screen === 'checkout' && (
            <CheckoutForm
              state={state}
              total={subtotal}
              finalTotal={finalTotal}
              dispatch={dispatch}
              setScreen={setScreen}
            />
          )}

          {/* Screen Navigation Button - Only shown on mobile */}
          {subtotal > 0 && (
            <div className="fixed bottom-0 left-0 right-0 lg:hidden p-4 bg-white border-t border-teal-200/50 shadow-2xl z-30">
              <motion.button
                onClick={() => setScreen(screen === 'products' ? 'checkout' : 'products')}
                whileTap={{ scale: 0.98 }}
                className={`w-full py-3 rounded-lg font-extrabold uppercase tracking-wider transition duration-300 flex items-center justify-center text-lg ${ACCENT_BG} text-white hover:bg-teal-600`}
              >
                {screen === 'products' ? (
                  <>
                    Proceed to Checkout (â‚¹{finalTotal.toFixed(2)}) <ArrowRight className="w-5 h-5 ml-2" />
                  </>
                ) : (
                  <>
                    <ChevronLeft className="w-5 h-5 mr-2" /> Back to Shopping
                  </>
                )}
              </motion.button>
            </div>
          )}
        </div>

        {/* Cart Sidebar/Drawer (Responsive) */}
        <AnimatePresence>
          {isCartOpen && (
            <motion.div
              // Mobile: inset-0 (full screen) | Desktop: fixed width sidebar
              initial={{ x: '100%' }}
              animate={{ x: 0 }}
              exit={{ x: '100%' }}
              transition={{ type: 'tween', duration: 0.3 }}
              className="fixed inset-0 lg:right-0 lg:top-0 lg:bottom-0 lg:w-80 bg-white border-l border-teal-200/50 shadow-2xl z-50 p-6 flex flex-col pt-20 lg:pt-24"
            >
              <h3 className={`text-2xl font-bold mb-4 ${ACCENT_COLOR} flex items-center justify-between`}>
                Your Cart
                <motion.button
                  onClick={() => setIsCartOpen(false)}
                  whileHover={{ scale: 1.1 }}
                  className="p-1 rounded-full bg-gray-100 text-gray-500 hover:text-gray-800 transition"
                >
                  <XCircle className="w-6 h-6" />
                </motion.button>
              </h3>

              <div className="flex-grow overflow-y-auto mb-4 pr-1">
                {state.cartItems.length === 0 ? (
                  <motion.p
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    className="text-gray-500 mt-10 text-center"
                  >
                    Your cart is empty. Start adding some fresh items!
                  </motion.p>
                ) : (
                  <CartItemList state={state} dispatch={dispatch} />
                )}
              </div>

              <div className="border-t border-gray-300 pt-4">
                <div className="flex justify-between text-gray-600 font-semibold mb-2">
                  <span>Subtotal:</span>
                  <span>â‚¹{subtotal.toFixed(2)}</span>
                </div>
                {state.discount.value > 0 && (
                  <div className="flex justify-between text-green-600 text-sm mb-2">
                    <span>Discount ({state.discount.description}):</span>
                    <span>- â‚¹{(subtotal - finalTotal).toFixed(2)}</span>
                  </div>
                )}
                <div className="flex justify-between text-2xl font-extrabold mb-4">
                  <span className="text-gray-900">Total:</span>
                  <span className={ACCENT_COLOR}>â‚¹{finalTotal.toFixed(2)}</span>
                </div>

                <motion.button
                  onClick={() => { setScreen('checkout'); setIsCartOpen(false); }}
                  disabled={subtotal === 0}
                  whileTap={{ scale: 0.98 }}
                  className={`w-full py-3 rounded-lg font-bold uppercase tracking-wider transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed ${ACCENT_BG} text-white hover:bg-teal-600`}
                >
                  Go to Checkout
                </motion.button>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </main>

      {/* Spin to Win Modal Render */}
      <AnimatePresence>
        {isSpinModalOpen && (
          <SpinToWinModal
            isOpen={isSpinModalOpen}
            onClose={() => setIsSpinModalOpen(false)}
            dispatch={dispatch}
            total={subtotal}
            hasSpun={state.hasSpun}
          />
        )}
      </AnimatePresence>

      {/* Product Detail Modal Render (NEW FEATURE) */}
      <AnimatePresence>
        {selectedProductForDetail && (
          <ProductDetailModal
            product={selectedProductForDetail}
            onClose={() => setSelectedProductForDetail(null)}
            onAddToCart={handleAddToCart}
            containerRef={containerRef}
          />
        )}
      </AnimatePresence>

      <Footer />

      <style>{`
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
        .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
      `}</style>
    </div>
  );
};

export default App;
